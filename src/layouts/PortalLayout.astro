---
import '../styles/portal.css';

export interface Props {
  title: string;
  persona: 'broker' | 'member' | 'employer';
}
const { title, persona } = Astro.props;
---
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{title} | Trustmark Benefits Portal</title>
  <script src="https://cdn.optimizely.com/js/6030541657473024.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />
</head>
<body>
  <div class="portal-shell">

    <header class="topbar">
      <a href="/" class="topbar-brand">
        <img src="/logo-with-tagline-inverse.webp" alt="Trustmark Benefits" class="topbar-logo" />
      </a>

      <nav class="topbar-persona-switcher">
        <a href="/broker" class={`persona-btn ${persona === 'broker' ? 'active' : ''}`}>Broker</a>
        <a href="/member" class={`persona-btn ${persona === 'member' ? 'active' : ''}`}>Member</a>
        <a href="/employer" class={`persona-btn ${persona === 'employer' ? 'active' : ''}`}>Employer</a>
        <a href="https://trustmark.optimarvin.com" target="_blank" class="persona-btn">Back to public site</a>
      </nav>

      <div class="topbar-right">

        <button class="hamburger" id="sidebar-toggle" aria-label="Open navigation" aria-expanded="false">
          <span></span>
          <span></span>
          <span></span>
        </button>

        <div class="font-size-control">
          <button class="fs-btn" id="fs-decrease" title="Decrease font size">Aâˆ’</button>
          <span class="fs-display" id="fs-display">24px</span>
          <button class="fs-btn" id="fs-increase" title="Increase font size">A+</button>
        </div>

        <div class="topbar-user">
          <div class="user-avatar">
            {persona === 'broker' && 'JR'}
            {persona === 'member' && 'AS'}
            {persona === 'employer' && 'MW'}
          </div>
          <span class="user-name">
            {persona === 'broker' && 'James Rivera'}
            {persona === 'member' && 'Amanda S.'}
            {persona === 'employer' && 'Mark W.'}
          </span>
        </div>
      </div>
    </header>

    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <aside class="sidebar">
      <div class="sidebar-persona-mobile">
        <a href="/broker" class={persona === 'broker' ? 'active' : ''}>Broker</a>
        <a href="/member" class={persona === 'member' ? 'active' : ''}>Member</a>
        <a href="/employer" class={persona === 'employer' ? 'active' : ''}>Employer</a>
      </div>

      {persona === 'broker' && (
        <>
          <span class="sidebar-section-label">Overview</span>
          <a href="/broker" class="sidebar-link active"><span class="sidebar-icon">ğŸ“Š</span> Dashboard</a>
          <a href="#" class="sidebar-link"><span class="sidebar-icon">ğŸ“‹</span> My Cases</a>
          <a href="#" class="sidebar-link"><span class="sidebar-icon">ğŸ¢</span> Accounts</a>
          <span class="sidebar-section-label">Tools</span>
          <a href="#" class="sidebar-link"><span class="sidebar-icon">ğŸ’°</span> Commissions</a>
          <a href="#" class="sidebar-link"><span class="sidebar-icon">ğŸ“„</span> Documents</a>
          <a href="#" class="sidebar-link"><span class="sidebar-icon">ğŸ“</span> Training</a>
          <span class="sidebar-section-label">Support</span>
          <a href="#" class="sidebar-link"><span class="sidebar-icon">ğŸ’¬</span> Contact Rep</a>
          <a href="#" class="sidebar-link"><span class="sidebar-icon">âš™ï¸</span> Settings</a>
        </>
      )}
      {persona === 'member' && (
        <>
          <span class="sidebar-section-label">My Benefits</span>
          <a href="/member" class="sidebar-link active"><span class="sidebar-icon">ğŸ </span> Dashboard</a>
          <a href="#" class="sidebar-link"><span class="sidebar-icon">ğŸ“‹</span> My Policies</a>
          <a href="#" class="sidebar-link"><span class="sidebar-icon">ğŸ©º</span> File a Claim</a>
          <a href="#" class="sidebar-link"><span class="sidebar-icon">ğŸ“</span> Claim History</a>
          <span class="sidebar-section-label">Resources</span>
          <a href="#" class="sidebar-link"><span class="sidebar-icon">ğŸ“š</span> Benefit Guide</a>
          <a href="#" class="sidebar-link"><span class="sidebar-icon">ğŸ’¬</span> Contact Us</a>
        </>
      )}
      {persona === 'employer' && (
        <>
          <span class="sidebar-section-label">Account</span>
          <a href="/employer" class="sidebar-link active"><span class="sidebar-icon">ğŸ“Š</span> Dashboard</a>
          <a href="#" class="sidebar-link"><span class="sidebar-icon">ğŸ‘¥</span> Employees</a>
          <a href="#" class="sidebar-link"><span class="sidebar-icon">ğŸ“‹</span> Enrollments</a>
          <span class="sidebar-section-label">Billing</span>
          <a href="#" class="sidebar-link"><span class="sidebar-icon">ğŸ’³</span> Billing</a>
          <a href="#" class="sidebar-link"><span class="sidebar-icon">ğŸ“„</span> Invoices</a>
          <span class="sidebar-section-label">Support</span>
          <a href="#" class="sidebar-link"><span class="sidebar-icon">ğŸ§‘â€ğŸ’¼</span> My Rep</a>
          <a href="#" class="sidebar-link"><span class="sidebar-icon">âš™ï¸</span> Settings</a>
        </>
      )}
    </aside>

    <main class="main-content">
      <slot />
    </main>

  </div>

  <script>
    const MIN = 12, MAX = 32, STEP = 1;
    const display = document.getElementById('fs-display') as HTMLElement;

    function getSize(): number {
      return parseInt(document.documentElement.style.fontSize) ||
             parseInt(getComputedStyle(document.documentElement).fontSize);
    }

    function setSize(px: number): void {
      const clamped = Math.min(Math.max(px, MIN), MAX);
      document.documentElement.style.fontSize = clamped + 'px';
      display.textContent = clamped + 'px';
      localStorage.setItem('portal-font-size', String(clamped));
    }

    (document.getElementById('fs-increase') as HTMLElement).addEventListener('click', () => setSize(getSize() + STEP));
    (document.getElementById('fs-decrease') as HTMLElement).addEventListener('click', () => setSize(getSize() - STEP));

    // Restore saved size on load
    const saved = localStorage.getItem('portal-font-size');
    if (saved) setSize(parseInt(saved));
    else display.textContent = getSize() + 'px';

    // Sidebar drawer toggle
    const toggle = document.getElementById('sidebar-toggle') as HTMLElement;
    const overlay = document.getElementById('sidebar-overlay') as HTMLElement;
    const shell = document.querySelector('.portal-shell') as HTMLElement;

    function openSidebar() {
      shell?.classList.add('sidebar-open');
      toggle?.setAttribute('aria-expanded', 'true');
    }
    function closeSidebar() {
      shell?.classList.remove('sidebar-open');
      toggle?.setAttribute('aria-expanded', 'false');
    }

    toggle?.addEventListener('click', () => {
      shell?.classList.contains('sidebar-open') ? closeSidebar() : openSidebar();
    });
    overlay?.addEventListener('click', closeSidebar);

    // Close sidebar on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeSidebar();
    });

    // Close sidebar when navigating (link click inside sidebar)
    document.querySelector('.sidebar')?.addEventListener('click', (e) => {
      if ((e.target as HTMLElement).tagName === 'A') closeSidebar();
    });
  </script>

  <script>
    // Live data simulation â€” nudges [data-live] text values and [data-live-bar] widths
    (function () {
      function parseNum(text: string) {
        const m = text.trim().match(/^([^0-9\-]*)([0-9,]+(?:\.[0-9]*)?)(.*)$/);
        if (!m) return null;
        const raw = parseFloat(m[2].replace(/,/g, ''));
        if (isNaN(raw)) return null;
        const decimals = (m[2].split('.')[1] ?? '').length;
        return { raw, prefix: m[1], suffix: m[3], hasCommas: m[2].includes(','), decimals };
      }

      function fmtNum(p: NonNullable<ReturnType<typeof parseNum>>, val: number): string {
        const fixed = val.toFixed(p.decimals);
        const [int, dec] = fixed.split('.');
        const intFmt = p.hasCommas ? int.replace(/\B(?=(\d{3})+(?!\d))/g, ',') : int;
        return p.prefix + (dec !== undefined ? `${intFmt}.${dec}` : intFmt) + p.suffix;
      }

      function nudge(val: number): number {
        if (val === 0) return 0;
        const up = Math.random() < 0.5;
        if (val < 50) return Math.max(0, val + (up ? 1 : -1));
        const pct = 0.004 + Math.random() * 0.014;
        return Math.max(0, val + val * pct * (up ? 1 : -1));
      }

      function flash(el: HTMLElement): void {
        el.classList.remove('live-flash');
        void el.offsetWidth; // restart animation
        el.classList.add('live-flash');
      }

      function schedule(fn: () => void): void {
        setTimeout(fn, 2500 + Math.random() * 4000);
      }

      // Text / currency values
      document.querySelectorAll<HTMLElement>('[data-live]').forEach(el => {
        function tick(): void {
          const p = parseNum(el.textContent ?? '');
          if (p) {
            const nv = p.decimals === 0 ? Math.round(nudge(p.raw)) : nudge(p.raw);
            el.textContent = fmtNum(p, nv);
            flash(el);
          }
          schedule(tick);
        }
        setTimeout(tick, 1000 + Math.random() * 4000);
      });

      // Bar widths
      document.querySelectorAll<HTMLElement>('[data-live-bar]').forEach(el => {
        let cur = parseFloat(el.dataset.liveBar ?? '0');
        function tick(): void {
          cur = Math.min(99, Math.max(3, cur + (Math.random() * 4 - 2)));
          el.style.width = cur.toFixed(1) + '%';
          schedule(tick);
        }
        setTimeout(tick, 1000 + Math.random() * 4000);
      });
    })();
  </script>
</body>
</html>
