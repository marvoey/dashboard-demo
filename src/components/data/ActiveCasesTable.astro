---
// DATA SOURCE: V3locity API (case status, renewal date) + SQL Server (premium, employee count)
//
// FETCH CALL â€” GET /api/broker/cases
// Called on component mount with the broker's session token.
// The API gateway merges two sources before responding:
//
//   const [v3Cases, sqlCases] = await Promise.all([
//     v3locityClient.getCasesForBroker(brokerId),   // status + renewalDate
//     db.query(
//       'SELECT case_id, employer_name, product, enrolled_count, monthly_premium ' +
//       'FROM broker_cases WHERE broker_id = @brokerId',
//       { brokerId }
//     ),                                             // employer, employees, premium
//   ]);
//   return Response.json({ cases: mergeCaseData(v3Cases, sqlCases) });
//
// Row-level security is enforced by the gateway â€” each broker
// receives only their own book of business.

interface Case {
  caseId: string;
  employer: string;
  product: string;
  employees: number;
  premium: string;
  renewalDate: string;
  status: string;
}
interface Props {
  cases: Case[];
}
const { cases } = Astro.props;
// â†‘ prototype: hardcoded array passed from the page
// â†‘ production: populated from GET /api/broker/cases response via useState
---

<div class="comp comp-table span-3">
  <div class="comp-bar">
    <div class="comp-bar-left">
      <a href="/components/data/active-cases-table" target="_blank" class="comp-explain-link">ðŸ—„ Data Table â†—</a>
      <span style="opacity:0.4;">Â·</span>
      <span style="font-weight:500; text-transform:none; letter-spacing:0;">V3locity API + SQL Server</span>
    </div>
    <div style="display:flex; gap:6px;">
      <span class="data-source">âš¡ V3locity API</span>
      <span class="data-source">ðŸ—„ SQL Server</span>
    </div>
  </div>
  <div class="comp-body-flush">
    <div style="padding: 14px 16px; border-bottom: 1px solid var(--border);">
      <span class="card-title">Active Cases & Policy Status</span>
    </div>
    <table>
      <thead>
        <tr>
          <th>Case ID</th>
          <th>Employer</th>
          <th>Product</th>
          <th>Employees</th>
          <th>Premium</th>
          <th>Renewal</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {cases.map(c => (
          <tr>
            <td class="mono">{c.caseId}</td>
            <td style="font-weight: 500;">{c.employer}</td>
            <td style="color: var(--text-muted);">{c.product}</td>
            <td data-live>{c.employees}</td>
            <td style="font-weight: 500;" data-live>{c.premium}</td>
            <td class="mono">{c.renewalDate}</td>
            <td>
              <span class={`status ${
                c.status === 'Active' ? 'status-active' :
                c.status === 'Renewal Due' ? 'status-renewal' :
                'status-pending'
              }`}>{c.status}</span>
            </td>
          </tr>
        ))}
      </tbody>
    </table>
  </div>
</div>
