---
// DATA SOURCE: SQL Server (employer_claims table, aggregated by product line)
//
// FETCH CALL â€” GET /api/employer/claims/utilization?period=ytd
// Called on component mount with the employer's session token.
//
//   useEffect(() => {
//     fetch('/api/employer/claims/utilization?period=ytd', {
//       headers: { Authorization: `Bearer ${getSessionToken()}` }
//     })
//       .then(r => r.json())
//       .then(({ utilization }) => setItems(utilization));
//   }, []);
//
// SERVER-SIDE QUERY:
//   SELECT product_line,
//          COUNT(*)             AS claim_count,
//          SUM(claim_amount)    AS total_amount,
//          AVG(utilization_pct) AS avg_pct
//   FROM employer_claims
//   WHERE employer_id = @employerId AND period_key = @period
//   GROUP BY product_line
//   ORDER BY total_amount DESC
//
// The `pct` field (0â€“100) drives the bar width via inline CSS.
// Adding a new product line requires only that claims data exists â€” no code change.

interface UtilizationItem {
  label: string;
  count: number;
  amount: string;
  pct: number;
}
interface Props {
  items: UtilizationItem[];
}
const { items } = Astro.props;
// â†‘ prototype: hardcoded array passed from the page
// â†‘ production: populated from GET /api/employer/claims/utilization response via useState
---

<div class="comp comp-table">
  <div class="comp-bar">
    <div class="comp-bar-left">
      <a href="/components/data/claims-utilization" target="_blank" class="comp-explain-link">ðŸ—„ Live Data â†—</a>
      <span style="opacity:0.4;">Â·</span>
      <span style="font-weight:500; text-transform:none; letter-spacing:0;">SQL Server</span>
    </div>
    <span class="data-source">Chart</span>
  </div>
  <div class="comp-body">
    <div class="card-title" style="margin-bottom:14px;">Claims Utilization (YTD)</div>
    {items.map(item => (
      <div style="margin-bottom: 14px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span style="font-size: 0.8125rem; font-weight: 500;">{item.label}</span>
          <span style="font-size: 0.75rem; color: var(--text-muted);"><span data-live>{item.count}</span> Â· <span data-live>{item.amount}</span></span>
        </div>
        <div style="height: 6px; background: var(--border); border-radius: 3px; overflow: hidden;">
          <div data-live-bar={item.pct} style={`height: 100%; width: ${item.pct}%; background: var(--blue); border-radius: 3px; transition: width 0.8s ease;`}></div>
        </div>
      </div>
    ))}
  </div>
</div>
