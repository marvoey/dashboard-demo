---
interface Props {
  result: unknown;
  label?: string;
}
const { result, label = 'result' } = Astro.props;
const resultJson = JSON.stringify(result, null, 2);
const uid = Math.random().toString(36).slice(2);
---

<div class="result-header">
  <strong style="color:#e2e8f0">{label}</strong>
  <button class="copy-btn" id={`copyBtn-${uid}`}>Copy JSON</button>
</div>
<div class="json-tree" id={`jsonTree-${uid}`}></div>

<script is:inline define:vars={{ resultJson, result, uid }}>
  // --- Copy button ---
  const btn = document.getElementById(`copyBtn-${uid}`);
  btn.addEventListener('click', () => {
    navigator.clipboard.writeText(resultJson).then(() => {
      btn.textContent = 'Copied!';
      btn.classList.add('copied');
      setTimeout(() => { btn.textContent = 'Copy JSON'; btn.classList.remove('copied'); }, 2000);
    });
  });

  // --- Collapsible JSON tree ---
  function renderValue(val, comma) {
    const c = comma ? '<span class="comma">,</span>' : '';
    if (val === null) return `<span class="null">null</span>${c}`;
    if (typeof val === 'boolean') return `<span class="bool">${val}</span>${c}`;
    if (typeof val === 'number') return `<span class="num">${val}</span>${c}`;
    if (typeof val === 'string') return `<span class="str">"${escHtml(val)}"</span>${c}`;
    if (Array.isArray(val)) return renderArray(val, comma);
    if (typeof val === 'object') return renderObject(val, comma);
    return escHtml(String(val)) + c;
  }

  function renderObject(obj, comma) {
    const entries = Object.entries(obj);
    if (entries.length === 0) return `<span class="brace">{}</span>${comma ? '<span class="comma">,</span>' : ''}`;
    const inner = entries.map(([k, v], i) =>
      `<div style="margin-left:1.25rem"><span class="key">"${escHtml(k)}"</span><span class="brace">: </span>${renderValue(v, i < entries.length - 1)}</div>`
    ).join('');
    const preview = entries.slice(0, 2).map(([k]) => `<span class="key">"${escHtml(k)}"</span>`).join('<span class="comma">, </span>') + (entries.length > 2 ? '<span class="brace"> â€¦</span>' : '');
    return `<details open><summary><span class="brace">{</span>${preview}<span class="brace">}</span></summary><span class="brace">{</span>${inner}<span class="brace">}</span>${comma ? '<span class="comma">,</span>' : ''}</details>`;
  }

  function renderArray(arr, comma) {
    if (arr.length === 0) return `<span class="brace">[]</span>${comma ? '<span class="comma">,</span>' : ''}`;
    const inner = arr.map((v, i) =>
      `<div style="margin-left:1.25rem">${renderValue(v, i < arr.length - 1)}</div>`
    ).join('');
    return `<details open><summary><span class="brace">[</span><span class="null">${arr.length} items</span><span class="brace">]</span></summary><span class="brace">[</span>${inner}<span class="brace">]</span>${comma ? '<span class="comma">,</span>' : ''}</details>`;
  }

  function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  document.getElementById(`jsonTree-${uid}`).innerHTML = renderValue(result, false);
</script>
