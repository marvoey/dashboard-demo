---
import AnnouncementBanner from '../cms/AnnouncementBanner.astro';
import PersonalizedHero from '../cms/PersonalizedHero.astro';
import ResourceDownload from '../cms/ResourceDownload.astro';
import SpotlightCard from '../cms/SpotlightCard.astro';
import RegulatoryNotice from '../cms/RegulatoryNotice.astro';
import CTAStrip from '../cms/CTAStrip.astro';
import ResultInspector from '../broadridge/ResultInspector.astro';

type Span = 'full' | '3/4' | '2/3' | '1/2' | '1/3' | '1/4';

interface CmsComponent {
  _metadata: { types: string[]; key: string; version: string; locale: string };
  [key: string]: unknown;
}

interface ColNode {
  key?: string;
  nodeType?: string;
  components?: CmsComponent[];
}

interface Props {
  span?: Span;
  label?: string;
  col?: ColNode;
}

const { span = '1/2', label, col } = Astro.props;

const spanClass: Record<Span, string> = {
  'full': 'col-full',
  '3/4':  'col-3-4',
  '2/3':  'col-2-3',
  '1/2':  'col-1-2',
  '1/3':  'col-1-3',
  '1/4':  'col-1-4',
};

const style = [
  'border: 2px dashed gold',
  'padding: 0.5rem',
].join('; ');
---

<div class={`layout-col ${spanClass[span]}`} style={style}>
  {label && <div class="band-label">{label}</div>}

  {(col?.components ?? []).map(component => {
    const type = component.type;
    const source = component._metadata?.key ?? '';

    return (
      <>
        {type === 'PortalWidgetAnnouncementBanner' && (
          <AnnouncementBanner
            tag={component.Tag as string}
            headline={component.Headline as string}
            body={(component.Body as { html: string })?.html ?? ''}
            ctaLabel={component.CtaLabel as string}
            ctaUrl={component.CtaUrl as string}
            source={source}
          />
        )}

        {type === 'PortalWidgetPersonalizedHero' && (
          <PersonalizedHero
            segment={component.Segment as string}
            eyebrow={component.Eyebrow as string}
            headline={component.Headline as string}
            subtext={component.Subtext as string}
            ctaLabel={component.CtaLabel as string}
            ctaUrl={component.CtaUrl as string}
            source={source}
          />
        )}

        {type === 'PortalWidgetSpotlightCard' && (
          <SpotlightCard
            tag={component.Tag as string}
            title={component.Title as string}
            description={component.Description as string}
            source={source}
          />
        )}

        {type === 'PortalWidgetRegulatoryNotice' && (
          <RegulatoryNotice
            noticeId={component.NoticeId as string}
            title={component.Title as string}
            body={(component.Body as { html: string })?.html ?? ''}
            effectiveDate={component.EffectiveDate as string}
            expiryDate={component.ExpiryDate as string}
            source={source}
          />
        )}

        {type === 'PortalWidgetResourceDownload' && (
          <ResourceDownload
            tag={component.Tag as string}
            title={component.Title as string}
            description={component.Description as string}
            fileType={component.FileType as string}
            fileSize={component.FileSize as string}
            assetUrl={(component.Asset as { key: string })?.key ?? ''}
            updatedAt={component.UpdatedAt as string}
            source={source}
          />
        )}

        {type === 'PortalWidgetCTAStrip' && (
          <CTAStrip
            message={(component.Message as { html: string })?.html ?? ''}
            primaryCtaLabel={component.PrimaryCtaLabel as string}
            primaryCtaUrl={component.PrimaryCtaUrl as string}
            secondaryCtaLabel={component.SecondaryCtaLabel as string | undefined}
            secondaryCtaUrl={component.SecondaryCtaUrl as string | undefined}
            source={source}
          />
        )}

        {!type && <ResultInspector result={component} label="Unknown component" />}
      </>
    );
  })}

  <slot />
</div>
