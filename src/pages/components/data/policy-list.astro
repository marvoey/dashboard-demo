---
import ComponentExplainLayout from '../../../layouts/ComponentExplainLayout.astro';

const componentCode = `// PolicyList.tsx
// Fetches the authenticated member's active policies from SQL Server
// via the Trustmark API gateway. Called directly on component mount.

import { useState, useEffect } from 'react';

interface Policy {
  product:        string   // Product name (e.g. "Group Term Life")
  policyId:       string   // Policy identifier
  premium:        string   // Member's monthly premium (formatted)
  coverageAmount: string   // Coverage limit (formatted)
}

export function PolicyList() {
  const [policies, setPolicies] = useState<Policy[]>([]);
  const [loading, setLoading]   = useState(true);

  useEffect(() => {
    fetch('/api/member/policies?status=active', {
      headers: { Authorization: \`Bearer \${getSessionToken()}\` }
    })
      .then(r => r.json())
      .then(({ policies }) => setPolicies(policies))
      .finally(() => setLoading(false));
  }, []);

  if (loading) return <div className="comp comp-table span-2">Loading…</div>;

  return (
    <div className="comp comp-table span-2">
      {/* policy rows rendered from policies[] */}
    </div>
  );
}`;

const fetchCode = `// portal/server/member.ts
// API route backing this component. Returns the member's active
// policies with premium and coverage details from SQL Server.

export async function GET(req: Request) {
  const memberId = getAuthenticatedMemberId(req);
  const status   = new URL(req.url).searchParams.get('status') ?? 'active';

  const rows = await db.query(
    \`SELECT
       product_name,
       policy_id,
       member_premium,
       coverage_amount
     FROM member_policies
     WHERE member_id = @memberId
       AND policy_status = @status
     ORDER BY product_name ASC\`,
    { memberId, status }
  );

  const policies = rows.map(r => ({
    product:        r.product_name,
    policyId:       r.policy_id,
    premium:        formatCurrency(r.member_premium) + '/mo',
    coverageAmount: formatCurrency(r.coverage_amount),
  }));

  return Response.json({ policies });
}`;
---

<ComponentExplainLayout
  title="Policy List"
  componentType="data"
  owner="Portal Engineering"
  description="A list of a member's active policies showing product name, policy ID, monthly premium, and coverage amount. Data is pulled live from SQL Server — no content authoring required."
>

  <!-- What this component does -->
  <div class="explain-section">
    <div class="explain-section-title">What This Component Does</div>
    <div class="explain-prose">
      <p>The Policy List is a member's reference view of their current Trustmark coverage. It lists every active policy the member holds, showing the product name, policy identifier, their individual monthly premium, and the coverage limit.</p>
      <p>This component has <strong>no CMS counterpart</strong>. Policy records are managed in the SQL Server policy administration database — nothing is authored by a content editor. When a member's coverage changes at renewal, the list updates automatically on their next login.</p>
      <p>The API filters to <code>status=active</code> by default. Terminated or lapsed policies are excluded unless the query parameter is changed.</p>
    </div>
  </div>

  <!-- Response shape -->
  <div class="explain-section">
    <div class="explain-section-title">API Response Shape — /api/member/policies</div>
    <table class="schema-table">
      <thead>
        <tr>
          <th>Field</th>
          <th>Type</th>
          <th>Source</th>
          <th>Example value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span class="schema-field">product</span></td>
          <td><span class="schema-type">string</span></td>
          <td><span class="owner-editor">SQL Server</span></td>
          <td>Group Term Life</td>
        </tr>
        <tr>
          <td><span class="schema-field">policyId</span></td>
          <td><span class="schema-type">string</span></td>
          <td><span class="owner-editor">SQL Server</span></td>
          <td>TM-POL-00291847</td>
        </tr>
        <tr>
          <td><span class="schema-field">premium</span></td>
          <td><span class="schema-type">string</span></td>
          <td><span class="owner-editor">SQL Server</span></td>
          <td>$18.40/mo</td>
        </tr>
        <tr>
          <td><span class="schema-field">coverageAmount</span></td>
          <td><span class="schema-type">string</span></td>
          <td><span class="owner-editor">SQL Server</span></td>
          <td>$150,000</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Component code -->
  <div class="explain-section">
    <div class="explain-section-title">React Component</div>
    <div class="code-block">
      <div class="code-block-header">
        <span class="code-block-lang">TSX</span>
        <span class="code-block-file">components/PolicyList.tsx</span>
      </div>
      <div class="code-block">
        <pre>{componentCode}</pre>
      </div>
    </div>
  </div>

  <!-- API route -->
  <div class="explain-section">
    <div class="explain-section-title">Where the Call Is Made</div>
    <div class="code-block">
      <div class="code-block-header">
        <span class="code-block-lang">TypeScript</span>
        <span class="code-block-file">server/member.ts → GET /api/member/policies</span>
      </div>
      <div class="code-block">
        <pre>{fetchCode}</pre>
      </div>
    </div>
  </div>

  <!-- Delivery flow -->
  <div class="explain-section">
    <div class="explain-section-title">Delivery Flow</div>
    <div class="delivery-flow">
      <div class="flow-step">
        <div class="flow-num">Step 1</div>
        <div class="flow-title">Member logs in</div>
        <div class="flow-desc">Portal authenticates the member. A session token is issued encoding the member's ID. No CMS interaction at any point.</div>
        <span class="flow-arrow">›</span>
      </div>
      <div class="flow-step">
        <div class="flow-num">Step 2</div>
        <div class="flow-title">Component mounts</div>
        <div class="flow-desc">The member dashboard renders. The PolicyList React component's <code>useEffect</code> fires immediately on mount.</div>
        <span class="flow-arrow">›</span>
      </div>
      <div class="flow-step">
        <div class="flow-num">Step 3</div>
        <div class="flow-title">Direct API call</div>
        <div class="flow-desc">The component calls <code>/api/member/policies?status=active</code>. The API queries SQL Server for the member's active policy records and returns them.</div>
        <span class="flow-arrow">›</span>
      </div>
      <div class="flow-step">
        <div class="flow-num">Step 4</div>
        <div class="flow-title">Component renders</div>
        <div class="flow-desc">The response populates <code>useState</code>. Each row reflects a real policy record with current premium and coverage values.</div>
      </div>
    </div>
  </div>

  <!-- Engineering controls -->
  <div class="explain-section">
    <div class="explain-section-title">What Requires a Code Change</div>
    <div class="no-redeploy">
      <div class="no-redeploy-title">This component has no non-engineering edit surface. A code deploy is required to:</div>
      <ul>
        <li>Add additional fields (e.g. effective date, beneficiary name)</li>
        <li>Change the status filter to include lapsed or pending policies</li>
        <li>Modify the sort order of policies</li>
        <li>Add an action button (e.g. "View Certificate of Coverage")</li>
        <li>Change the endpoint or add query parameters</li>
      </ul>
      <div class="no-redeploy-title" style="margin-top: 16px;">Updates automatically without a deploy:</div>
      <ul>
        <li>Premium amounts update at renewal when SQL records are modified</li>
        <li>New policies appear automatically when an enrollment is activated</li>
        <li>Terminated policies disappear from the list without any engineering action</li>
      </ul>
    </div>
  </div>

</ComponentExplainLayout>
