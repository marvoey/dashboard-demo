---
import ComponentExplainLayout from '../../../layouts/ComponentExplainLayout.astro';

const componentCode = `// EnrollmentTable.tsx
// Fetches current enrollment counts and monthly premium totals for
// the authenticated employer group from SQL Server via the Trustmark
// API gateway. Called directly on component mount.

import { useState, useEffect } from 'react';

interface Product {
  name:     string   // Product name (e.g. "Critical Illness")
  enrolled: number   // Number of enrolled employees
  premium:  string   // Total monthly premium for this product (formatted)
}

export function EnrollmentTable() {
  const [products, setProducts] = useState<Product[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetch('/api/employer/enrollment', {
      headers: { Authorization: \`Bearer \${getSessionToken()}\` }
    })
      .then(r => r.json())
      .then(({ products }) => setProducts(products))
      .finally(() => setLoading(false));
  }, []);

  if (loading) return <div className="comp comp-table span-2">Loading…</div>;

  return (
    <div className="comp comp-table span-2">
      {/* table rows rendered from products[] */}
    </div>
  );
}`;

const fetchCode = `// portal/server/employer.ts
// API route backing this component. Returns current enrollment
// and premium totals per product line for the employer group.

export async function GET(req: Request) {
  const employerId = getAuthenticatedEmployerId(req);

  const rows = await db.query(
    \`SELECT
       product_name,
       COUNT(DISTINCT employee_id)  AS enrolled_count,
       SUM(monthly_premium)         AS total_premium
     FROM employer_enrollments
     WHERE employer_id = @employerId
       AND status      = 'active'
     GROUP BY product_name
     ORDER BY total_premium DESC\`,
    { employerId }
  );

  const products = rows.map(r => ({
    name:     r.product_name,
    enrolled: r.enrolled_count,
    premium:  formatCurrency(r.total_premium) + '/mo',
  }));

  return Response.json({ products });
}`;
---

<ComponentExplainLayout
  title="Enrollment Table"
  componentType="data"
  owner="Portal Engineering"
  description="A two-column data table showing enrollment counts and monthly premium totals per product line for the authenticated employer group. Data is pulled live from SQL Server — no content authoring required."
>

  <!-- What this component does -->
  <div class="explain-section">
    <div class="explain-section-title">What This Component Does</div>
    <div class="explain-prose">
      <p>The Enrollment Table gives employer administrators a clear view of which products their workforce is enrolled in and what the group is paying each month. Each row shows a product line with the number of actively enrolled employees and the corresponding monthly premium total.</p>
      <p>This component has <strong>no CMS counterpart</strong>. Row content is calculated entirely from active enrollment records in SQL Server. When an employee enrolls or terminates, the counts and premiums update automatically on the next page load.</p>
      <p>The API filters to active enrollments only. Rows are ordered by total premium descending, so the highest-cost products appear first.</p>
    </div>
  </div>

  <!-- Response shape -->
  <div class="explain-section">
    <div class="explain-section-title">API Response Shape — /api/employer/enrollment</div>
    <table class="schema-table">
      <thead>
        <tr>
          <th>Field</th>
          <th>Type</th>
          <th>Source</th>
          <th>Example value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span class="schema-field">name</span></td>
          <td><span class="schema-type">string</span></td>
          <td><span class="owner-editor">SQL Server</span></td>
          <td>Critical Illness</td>
        </tr>
        <tr>
          <td><span class="schema-field">enrolled</span></td>
          <td><span class="schema-type">number</span></td>
          <td><span class="owner-editor">SQL Server</span></td>
          <td>87</td>
        </tr>
        <tr>
          <td><span class="schema-field">premium</span></td>
          <td><span class="schema-type">string</span></td>
          <td><span class="owner-editor">SQL Server</span></td>
          <td>$3,654/mo</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Component code -->
  <div class="explain-section">
    <div class="explain-section-title">React Component</div>
    <div class="code-block">
      <div class="code-block-header">
        <span class="code-block-lang">TSX</span>
        <span class="code-block-file">components/EnrollmentTable.tsx</span>
      </div>
      <div class="code-block">
        <pre>{componentCode}</pre>
      </div>
    </div>
  </div>

  <!-- API route -->
  <div class="explain-section">
    <div class="explain-section-title">Where the Call Is Made</div>
    <div class="code-block">
      <div class="code-block-header">
        <span class="code-block-lang">TypeScript</span>
        <span class="code-block-file">server/employer.ts → GET /api/employer/enrollment</span>
      </div>
      <div class="code-block">
        <pre>{fetchCode}</pre>
      </div>
    </div>
  </div>

  <!-- Delivery flow -->
  <div class="explain-section">
    <div class="explain-section-title">Delivery Flow</div>
    <div class="delivery-flow">
      <div class="flow-step">
        <div class="flow-num">Step 1</div>
        <div class="flow-title">Employer logs in</div>
        <div class="flow-desc">Portal authenticates the employer admin. A session token is issued encoding the employer group ID. No CMS interaction at any point.</div>
        <span class="flow-arrow">›</span>
      </div>
      <div class="flow-step">
        <div class="flow-num">Step 2</div>
        <div class="flow-title">Component mounts</div>
        <div class="flow-desc">The employer dashboard renders. The EnrollmentTable React component's <code>useEffect</code> fires immediately on mount.</div>
        <span class="flow-arrow">›</span>
      </div>
      <div class="flow-step">
        <div class="flow-num">Step 3</div>
        <div class="flow-title">Direct API call</div>
        <div class="flow-desc">The component calls <code>/api/employer/enrollment</code> with the session token. The API aggregates active enrollment records from SQL Server by product line.</div>
        <span class="flow-arrow">›</span>
      </div>
      <div class="flow-step">
        <div class="flow-num">Step 4</div>
        <div class="flow-title">Component renders</div>
        <div class="flow-desc">The response populates <code>useState</code>. The table re-renders with live enrollment counts and premium totals — no hardcoded values anywhere.</div>
      </div>
    </div>
  </div>

  <!-- Engineering controls -->
  <div class="explain-section">
    <div class="explain-section-title">What Requires a Code Change</div>
    <div class="no-redeploy">
      <div class="no-redeploy-title">This component has no non-engineering edit surface. A code deploy is required to:</div>
      <ul>
        <li>Add additional columns (e.g. eligible employee count, participation rate)</li>
        <li>Change the sort order or add filtering by product category</li>
        <li>Modify the status filter (currently shows active enrollments only)</li>
        <li>Change the endpoint or add query parameters for a date range</li>
        <li>Add a totals row at the bottom of the table</li>
      </ul>
      <div class="no-redeploy-title" style="margin-top: 16px;">Updates automatically without a deploy:</div>
      <ul>
        <li>Enrolled counts change as employees enroll, change elections, or terminate</li>
        <li>Premium totals recalculate on each page load from the SQL warehouse</li>
        <li>New product lines appear automatically when enrollment records exist for them</li>
      </ul>
    </div>
  </div>

</ComponentExplainLayout>
