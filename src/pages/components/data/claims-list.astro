---
import ComponentExplainLayout from '../../../layouts/ComponentExplainLayout.astro';

const componentCode = `// ClaimsList.tsx
// Fetches the authenticated member's five most recent claims from
// SQL Server via the Trustmark API gateway. Called directly on
// component mount — no CMS layer involved.

import { useState, useEffect } from 'react';

interface Claim {
  type:          string                          // Claim type (e.g. "Hospital Indemnity")
  submittedDate: string                          // ISO 8601 submission date
  amount:        string                          // Formatted dollar amount
  status:        'Paid' | 'In Review' | 'Pending'
}

export function ClaimsList() {
  const [claims, setClaims] = useState<Claim[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetch('/api/member/claims/recent?limit=5', {
      headers: { Authorization: \`Bearer \${getSessionToken()}\` }
    })
      .then(r => r.json())
      .then(({ claims }) => setClaims(claims))
      .finally(() => setLoading(false));
  }, []);

  if (loading) return <div className="comp comp-table">Loading…</div>;

  return (
    <div className="comp comp-table">
      {/* claim rows rendered from claims[] */}
    </div>
  );
}`;

const fetchCode = `// portal/server/member.ts
// API route backing this component. Queries SQL Server for the
// member's five most recent claims ordered by submission date.

export async function GET(req: Request) {
  const memberId = getAuthenticatedMemberId(req);
  const limit    = Number(new URL(req.url).searchParams.get('limit') ?? 5);

  const rows = await db.query(
    \`SELECT TOP (@limit)
       claim_type, submitted_date, claim_amount, claim_status
     FROM member_claims
     WHERE member_id = @memberId
     ORDER BY submitted_date DESC\`,
    { memberId, limit }
  );

  const claims = rows.map(r => ({
    type:          r.claim_type,
    submittedDate: r.submitted_date,
    amount:        formatCurrency(r.claim_amount),
    status:        r.claim_status,
  }));

  return Response.json({ claims });
}`;
---

<ComponentExplainLayout
  title="Claims List"
  componentType="data"
  owner="Portal Engineering"
  description="A compact list showing a member's five most recent claims with submission date, dollar amount, and current status. Data is pulled live from SQL Server — no content authoring required."
>

  <!-- What this component does -->
  <div class="explain-section">
    <div class="explain-section-title">What This Component Does</div>
    <div class="explain-prose">
      <p>The Claims List surfaces a member's most recent claim activity directly on their dashboard. It shows up to five claims, each with the claim type, submission date, payment amount, and current processing status.</p>
      <p>This component has <strong>no CMS counterpart</strong>. There are no editable fields — every row reflects a real claim record stored in SQL Server. Status values (<em>Paid</em>, <em>In Review</em>, <em>Pending</em>) are set by the claims processing workflow, not by a content editor.</p>
      <p>The component fetches on mount using the member's session token. Row-level security in the API ensures a member can only see their own claims.</p>
    </div>
  </div>

  <!-- Response shape -->
  <div class="explain-section">
    <div class="explain-section-title">API Response Shape — /api/member/claims/recent</div>
    <table class="schema-table">
      <thead>
        <tr>
          <th>Field</th>
          <th>Type</th>
          <th>Source</th>
          <th>Example value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span class="schema-field">type</span></td>
          <td><span class="schema-type">string</span></td>
          <td><span class="owner-editor">SQL Server</span></td>
          <td>Hospital Indemnity</td>
        </tr>
        <tr>
          <td><span class="schema-field">submittedDate</span></td>
          <td><span class="schema-type">string (ISO 8601)</span></td>
          <td><span class="owner-editor">SQL Server</span></td>
          <td>2024-11-03</td>
        </tr>
        <tr>
          <td><span class="schema-field">amount</span></td>
          <td><span class="schema-type">string</span></td>
          <td><span class="owner-editor">SQL Server</span></td>
          <td>$1,200.00</td>
        </tr>
        <tr>
          <td><span class="schema-field">status</span></td>
          <td><span class="schema-type">enum</span></td>
          <td><span class="owner-editor">SQL Server</span></td>
          <td>"Paid" | "In Review" | "Pending"</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Component code -->
  <div class="explain-section">
    <div class="explain-section-title">React Component</div>
    <div class="code-block">
      <div class="code-block-header">
        <span class="code-block-lang">TSX</span>
        <span class="code-block-file">components/ClaimsList.tsx</span>
      </div>
      <div class="code-block">
        <pre>{componentCode}</pre>
      </div>
    </div>
  </div>

  <!-- API route -->
  <div class="explain-section">
    <div class="explain-section-title">Where the Call Is Made</div>
    <div class="code-block">
      <div class="code-block-header">
        <span class="code-block-lang">TypeScript</span>
        <span class="code-block-file">server/member.ts → GET /api/member/claims/recent</span>
      </div>
      <div class="code-block">
        <pre>{fetchCode}</pre>
      </div>
    </div>
  </div>

  <!-- Delivery flow -->
  <div class="explain-section">
    <div class="explain-section-title">Delivery Flow</div>
    <div class="delivery-flow">
      <div class="flow-step">
        <div class="flow-num">Step 1</div>
        <div class="flow-title">Member logs in</div>
        <div class="flow-desc">Portal authenticates the member. A session token is issued encoding the member's ID. No CMS interaction at any point.</div>
        <span class="flow-arrow">›</span>
      </div>
      <div class="flow-step">
        <div class="flow-num">Step 2</div>
        <div class="flow-title">Component mounts</div>
        <div class="flow-desc">The member dashboard renders. The ClaimsList React component's <code>useEffect</code> fires immediately on mount.</div>
        <span class="flow-arrow">›</span>
      </div>
      <div class="flow-step">
        <div class="flow-num">Step 3</div>
        <div class="flow-title">Direct API call</div>
        <div class="flow-desc">The component calls <code>/api/member/claims/recent</code> with the session token. The API queries SQL Server and returns the most recent claims.</div>
        <span class="flow-arrow">›</span>
      </div>
      <div class="flow-step">
        <div class="flow-num">Step 4</div>
        <div class="flow-title">Component renders</div>
        <div class="flow-desc">The response populates <code>useState</code>. Each row reflects a real claim record with its current processing status.</div>
      </div>
    </div>
  </div>

  <!-- Engineering controls -->
  <div class="explain-section">
    <div class="explain-section-title">What Requires a Code Change</div>
    <div class="no-redeploy">
      <div class="no-redeploy-title">This component has no non-engineering edit surface. A code deploy is required to:</div>
      <ul>
        <li>Change the number of claims displayed (currently limited to 5)</li>
        <li>Add additional fields (e.g. claim number, benefit type)</li>
        <li>Modify the sort order or filtering logic</li>
        <li>Change how status badges are styled or labelled</li>
        <li>Point the fetch at a different endpoint or change query parameters</li>
      </ul>
      <div class="no-redeploy-title" style="margin-top: 16px;">Updates automatically without a deploy:</div>
      <ul>
        <li>New claims appear as they are entered into SQL Server</li>
        <li>Status transitions (Pending → In Review → Paid) reflect on next page load</li>
        <li>Claim amounts update if the record is amended in the source system</li>
      </ul>
    </div>
  </div>

</ComponentExplainLayout>
