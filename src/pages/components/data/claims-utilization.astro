---
import ComponentExplainLayout from '../../../layouts/ComponentExplainLayout.astro';

const componentCode = `// ClaimsUtilization.tsx
// Fetches year-to-date claims utilization data for the authenticated
// employer group from SQL Server. Called directly on component mount.

import { useState, useEffect } from 'react';

interface UtilizationItem {
  label:  string   // Product line label (e.g. "Critical Illness")
  count:  number   // Number of claims submitted YTD
  amount: string   // Total paid amount YTD (formatted)
  pct:    number   // Utilization percentage vs. expected (0–100)
}

export function ClaimsUtilization() {
  const [items, setItems] = useState<UtilizationItem[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetch('/api/employer/claims/utilization?period=ytd', {
      headers: { Authorization: \`Bearer \${getSessionToken()}\` }
    })
      .then(r => r.json())
      .then(({ utilization }) => setItems(utilization))
      .finally(() => setLoading(false));
  }, []);

  if (loading) return <div className="comp comp-table">Loading…</div>;

  return (
    <div className="comp comp-table">
      {/* bar chart rows rendered from items[] */}
    </div>
  );
}`;

const fetchCode = `// portal/server/employer.ts
// API route backing this component. Aggregates YTD claims data from
// SQL Server grouped by product line for the employer group.

export async function GET(req: Request) {
  const employerId = getAuthenticatedEmployerId(req);
  const period     = new URL(req.url).searchParams.get('period') ?? 'ytd';

  const rows = await db.query(
    \`SELECT
       product_line,
       COUNT(*)            AS claim_count,
       SUM(claim_amount)   AS total_amount,
       AVG(utilization_pct) AS avg_pct
     FROM employer_claims
     WHERE employer_id = @employerId
       AND period_key  = @period
     GROUP BY product_line
     ORDER BY total_amount DESC\`,
    { employerId, period }
  );

  const utilization = rows.map(r => ({
    label:  r.product_line,
    count:  r.claim_count,
    amount: formatCurrency(r.total_amount),
    pct:    Math.round(r.avg_pct),
  }));

  return Response.json({ utilization });
}`;
---

<ComponentExplainLayout
  title="Claims Utilization"
  componentType="data"
  owner="Portal Engineering"
  description="A horizontal bar chart showing year-to-date claims utilization broken down by product line for the authenticated employer group. Data is aggregated live from SQL Server — no content authoring required."
>

  <!-- What this component does -->
  <div class="explain-section">
    <div class="explain-section-title">What This Component Does</div>
    <div class="explain-prose">
      <p>The Claims Utilization chart gives employer administrators a YTD view of how their workforce is using each benefit product. Each bar represents a product line and shows the claim count, total paid amount, and a percentage bar indicating utilization relative to the expected baseline.</p>
      <p>This component has <strong>no CMS counterpart</strong>. The bars, labels, and percentages are calculated from real claims data in SQL Server — nothing is authored or configured by a content editor. Adding a new product line to the chart requires only that the underlying data exists; the component renders whatever the API returns.</p>
      <p>The <code>period</code> query parameter defaults to <code>ytd</code> (year-to-date) but can be extended to support rolling windows or prior-year comparisons without UI changes.</p>
    </div>
  </div>

  <!-- Response shape -->
  <div class="explain-section">
    <div class="explain-section-title">API Response Shape — /api/employer/claims/utilization</div>
    <table class="schema-table">
      <thead>
        <tr>
          <th>Field</th>
          <th>Type</th>
          <th>Source</th>
          <th>Example value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span class="schema-field">label</span></td>
          <td><span class="schema-type">string</span></td>
          <td><span class="owner-editor">SQL Server</span></td>
          <td>Critical Illness</td>
        </tr>
        <tr>
          <td><span class="schema-field">count</span></td>
          <td><span class="schema-type">number</span></td>
          <td><span class="owner-editor">SQL Server</span></td>
          <td>14</td>
        </tr>
        <tr>
          <td><span class="schema-field">amount</span></td>
          <td><span class="schema-type">string</span></td>
          <td><span class="owner-editor">SQL Server</span></td>
          <td>$22,400</td>
        </tr>
        <tr>
          <td><span class="schema-field">pct</span></td>
          <td><span class="schema-type">number (0–100)</span></td>
          <td><span class="owner-editor">SQL Server</span></td>
          <td>68</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Component code -->
  <div class="explain-section">
    <div class="explain-section-title">React Component</div>
    <div class="code-block">
      <div class="code-block-header">
        <span class="code-block-lang">TSX</span>
        <span class="code-block-file">components/ClaimsUtilization.tsx</span>
      </div>
      <div class="code-block">
        <pre>{componentCode}</pre>
      </div>
    </div>
  </div>

  <!-- API route -->
  <div class="explain-section">
    <div class="explain-section-title">Where the Call Is Made</div>
    <div class="code-block">
      <div class="code-block-header">
        <span class="code-block-lang">TypeScript</span>
        <span class="code-block-file">server/employer.ts → GET /api/employer/claims/utilization</span>
      </div>
      <div class="code-block">
        <pre>{fetchCode}</pre>
      </div>
    </div>
  </div>

  <!-- Delivery flow -->
  <div class="explain-section">
    <div class="explain-section-title">Delivery Flow</div>
    <div class="delivery-flow">
      <div class="flow-step">
        <div class="flow-num">Step 1</div>
        <div class="flow-title">Employer logs in</div>
        <div class="flow-desc">Portal authenticates the employer admin. A session token is issued encoding the employer group ID. No CMS interaction at any point.</div>
        <span class="flow-arrow">›</span>
      </div>
      <div class="flow-step">
        <div class="flow-num">Step 2</div>
        <div class="flow-title">Component mounts</div>
        <div class="flow-desc">The employer dashboard renders. The ClaimsUtilization React component's <code>useEffect</code> fires immediately on mount.</div>
        <span class="flow-arrow">›</span>
      </div>
      <div class="flow-step">
        <div class="flow-num">Step 3</div>
        <div class="flow-title">Direct API call</div>
        <div class="flow-desc">The component calls <code>/api/employer/claims/utilization?period=ytd</code>. The API aggregates YTD claims from SQL Server grouped by product line.</div>
        <span class="flow-arrow">›</span>
      </div>
      <div class="flow-step">
        <div class="flow-num">Step 4</div>
        <div class="flow-title">Component renders</div>
        <div class="flow-desc">The response populates <code>useState</code>. Each bar reflects live aggregated data — bar widths are calculated from the <code>pct</code> field returned by the API.</div>
      </div>
    </div>
  </div>

  <!-- Engineering controls -->
  <div class="explain-section">
    <div class="explain-section-title">What Requires a Code Change</div>
    <div class="no-redeploy">
      <div class="no-redeploy-title">This component has no non-engineering edit surface. A code deploy is required to:</div>
      <ul>
        <li>Change the chart style (e.g. switch from horizontal bars to another chart type)</li>
        <li>Add additional metrics per row (e.g. prior-year comparison)</li>
        <li>Change the default period from YTD to a rolling window</li>
        <li>Modify the sort order of product lines</li>
        <li>Change the bar color or threshold styling</li>
      </ul>
      <div class="no-redeploy-title" style="margin-top: 16px;">Updates automatically without a deploy:</div>
      <ul>
        <li>Bar widths and counts update as new claims are processed in SQL Server</li>
        <li>New product lines appear automatically if the employer has claims for them</li>
        <li>Amounts recalculate on each page load — always reflects the latest warehouse sync</li>
      </ul>
    </div>
  </div>

</ComponentExplainLayout>
