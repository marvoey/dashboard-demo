---
import BroadridgeLayout from '../layouts/BroadridgeLayout.astro';
import { cmsClient } from '../lib/cms';

// --- Domain resolution ---
// CMS_ORIGIN is the canonical domain registered in Optimizely Graph.
// DOMAIN_ALIASES is a comma-separated list of hosts that should map to it
// (e.g. localhost:4321 in local dev).
const CMS_ORIGIN = import.meta.env.CMS_ORIGIN as string | undefined;
const DOMAIN_ALIASES = import.meta.env.DOMAIN_ALIASES as string | undefined;
const aliases = new Set((DOMAIN_ALIASES ?? '').split(',').map((s) => s.trim()).filter(Boolean));
const base = CMS_ORIGIN && aliases.has(Astro.url.host) ? CMS_ORIGIN : Astro.url.origin;

// --- Path resolution ---
// Optimizely Graph stores URLs with a trailing slash; also check without.
const urlPath    = `${Astro.url.pathname.replace(/\/$/, '')}/`;
const urlNoSlash = urlPath.replace(/\/$/, '');

// --- Query ---
const CONTENT_BY_PATH = `
  query contentByPath($base: String, $url: String!, $urlNoSlash: String!) {
    _Experience(
      where: {
        _metadata: { url: { base: { eq: $base } } }
        _and: [{
          _or: [
            { _metadata: { url: { default:      { eq: $url        } } } }
            { _metadata: { url: { default:      { eq: $urlNoSlash } } } }
            { _metadata: { url: { hierarchical: { eq: $url        } } } }
          ]
        }]
      }
    ) {
      item {
        _metadata { key version locale types }
        composition {
          key nodeType type displayName
          displaySettings { key value }
          nodes {
            key nodeType type displayName displayTemplateKey
            displaySettings { key value }
            ... on CompositionStructureNode {
              nodes {
                key nodeType type displayName displayTemplateKey
                displaySettings { key value }
                ... on CompositionStructureNode {
                  nodes {
                    key nodeType type displayName displayTemplateKey
                    displaySettings { key value }
                    ... on CompositionComponentNode {
                      component {
                        _metadata { types key version locale }
                        _json
                      }
                    }
                  }
                }
                ... on CompositionComponentNode {
                  component {
                    _metadata { types key version locale }
                    _json
                  }
                }
              }
            }
            ... on CompositionComponentNode {
              component {
                _metadata { types key version locale }
                _json
              }
            }
          }
        }
      }
    }
  }
`;

const result = await cmsClient.request(CONTENT_BY_PATH, { base, url: urlPath, urlNoSlash });
const item   = result?._Experience?.item ?? null;
---

<BroadridgeLayout title="Demo" persona="demo">
  <pre style="background:#111;color:#e0e0e0;padding:1.5rem;border-radius:6px;font-size:0.75rem;overflow-x:auto;white-space:pre-wrap;">
    base:      {base}
    url:       {urlPath}
    urlNoSlash:{urlNoSlash}

    result: {JSON.stringify(result, null, 2)}
  </pre>
</BroadridgeLayout>
